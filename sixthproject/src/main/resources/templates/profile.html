<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Профиль пользователя</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: #f6f7fb; }
        .navbar-blur { backdrop-filter: saturate(180%) blur(10px); background: linear-gradient(90deg,#fff 0,#f9fbff 100%); border-bottom: 1px solid #eef2f7; }
        .brand-title { font-weight: 700; letter-spacing: .3px; }
        .toolbar .btn { border-radius: 10px; font-weight: 500; }
        .profile-card { border: none; border-radius: 16px; box-shadow: 0 8px 24px rgba(16,24,40,.08); }
        .profile-header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 16px 16px 0 0; padding: 30px; }
        .profile-avatar { width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,.2); display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-bottom: 16px; }
        .profile-info { padding: 30px; }
        .info-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f3f4f6; }
        .info-item:last-child { border-bottom: none; }
        .info-icon { width: 40px; height: 40px; border-radius: 50%; background: #f8fafc; display: flex; align-items: center; justify-content: center; margin-right: 16px; color: #6b7280; }
        .info-label { font-weight: 600; color: #374151; margin-bottom: 4px; }
        .info-value { color: #6b7280; }
        .role-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .role-user { background: #e3f2fd; color: #1976d2; }
        .role-customer { background: #f3e5f5; color: #7b1fa2; }
        .role-seller { background: #e8f5e8; color: #388e3c; }
        .role-admin { background: #fff3e0; color: #f57c00; }
        .orders-card { border: none; border-radius: 16px; box-shadow: 0 8px 24px rgba(16,24,40,.08); }
        .order-item { border: none; border-radius: 12px; background: #fff; margin-bottom: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(16,24,40,.06); }
        .order-item:hover { box-shadow: 0 4px 12px rgba(16,24,40,.1); }
        .order-id { font-weight: 600; color: #374151; }
        .order-date { color: #6b7280; font-size: 0.875rem; }
        .order-amount { font-weight: 700; color: #0d6efd; font-size: 1.1rem; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-created { background: #fff3cd; color: #856404; }
        .status-paid { background: #d1ecf1; color: #0c5460; }
        .status-shipped { background: #d4edda; color: #155724; }
        .status-completed { background: #d1ecf1; color: #0c5460; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .empty-state { text-align: center; padding: 60px 20px; color: #6b7280; }
        .empty-state i { font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; }
        .btn-logout { background: linear-gradient(135deg, #dc3545, #c82333); border: none; color: white; font-weight: 600; }
        .btn-logout:hover { background: linear-gradient(135deg, #c82333, #bd2130); color: white; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light navbar-blur sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand brand-title" href="/catalog">
                <i class="fas fa-user me-2"></i>Cosmetic Store
            </a>
            <div class="toolbar d-flex gap-2">
                <a href="/catalog" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-1"></i>Каталог
                </a>
                <a href="/cart-page" id="cartLink" class="btn btn-outline-secondary">
                    <i class="fas fa-shopping-cart me-1"></i>Корзина
                </a>
                <a href="/logout" class="btn btn-logout">
                    <i class="fas fa-sign-out-alt me-1"></i>Выйти
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4 fw-bold text-dark">
                    <i class="fas fa-user me-2 text-primary"></i>Профиль пользователя
                </h2>

                <div class="row">
                    <div class="col-lg-4">
                        <div class="card profile-card">
                            <div class="profile-header">
                                <div class="profile-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <h4 class="mb-1" id="userName">Загрузка...</h4>
                                <p class="mb-0" id="userRole">Загрузка...</p>
                            </div>
                            <div class="profile-info">
                                <div class="info-item">
                                    <div class="info-icon">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div>
                                        <div class="info-label">Имя пользователя</div>
                                        <div class="info-value" id="userUsername">-</div>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-icon">
                                        <i class="fas fa-envelope"></i>
                                    </div>
                                    <div>
                                        <div class="info-label">Email</div>
                                        <div class="info-value" id="userEmail">-</div>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-icon">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                    <div>
                                        <div class="info-label">Роль</div>
                                        <div class="info-value" id="userRoleBadge">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8">
                        <div class="card mb-4 addresses-card">
                            <div class="card-header" style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-radius: 16px 16px 0 0; border-bottom: 1px solid #eef2f7;">
                                <h5 class="fw-bold mb-0">
                                    <i class="fas fa-map-marker-alt me-2"></i>Мои адреса
                                </h5>
                            </div>
                            <div class="card-body">
                                <form id="addressForm" class="row g-2 mb-3">
                                    <div class="col-md-5">
                                        <input id="addrStreet" class="form-control" placeholder="Улица, дом" required>
                                    </div>
                                    <div class="col-md-3">
                                        <input id="addrCity" class="form-control" placeholder="Город" required>
                                    </div>
                                    <div class="col-md-2">
                                        <input id="addrPostal" class="form-control" placeholder="Индекс" required>
                                    </div>
                                    <div class="col-md-2">
                                        <input id="addrCountry" class="form-control" placeholder="Страна" required>
                                    </div>
                                    <div class="col-12 text-end">
                                        <button class="btn btn-primary" type="submit"><i class="fas fa-plus me-1"></i>Добавить адрес</button>
                                    </div>
                                </form>
                                <div id="addressesList" class="list-group"></div>
                                <div id="emptyAddresses" class="empty-state d-none">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <h5>Адресов пока нет</h5>
                                    <p>Добавьте адрес доставки с помощью формы выше</p>
                                </div>
                            </div>
                        </div>
                        <div class="card orders-card">
                            <div class="card-header" style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-radius: 16px 16px 0 0; border-bottom: 1px solid #eef2f7;">
                                <h5 class="fw-bold mb-0">
                                    <i class="fas fa-shopping-bag me-2"></i>Мои заказы
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="ordersList">
                                </div>
                                <div id="emptyOrders" class="empty-state d-none">
                                    <i class="fas fa-shopping-bag"></i>
                                    <h5>Заказов пока нет</h5>
                                    <p>Сделайте свой первый заказ в нашем магазине</p>
                                    <a href="/catalog" class="btn btn-primary">
                                        <i class="fas fa-shopping-bag me-1"></i>Перейти в каталог
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            currentUser = await getMe();
            if (!currentUser) {
                window.location.href = '/login';
                return;
            }

            await renderUser(currentUser);
            
            const isSeller = currentUser.role === 'SELLER';
            const isAdmin = currentUser.role === 'ADMIN';
            
            if (isSeller || isAdmin) {
                document.getElementById('cartLink').style.display = 'none';
            }
            
            if (!isSeller && !isAdmin) {
                await Promise.all([loadAddresses(), attachAddressForm(), loadOrders()]);
            } else {
                document.querySelector('.orders-card').style.display = 'none';
                const addressesCard = document.querySelector('.addresses-card');
                if (addressesCard) addressesCard.style.display = 'none';
            }
        });

        async function getMe() {
            try {
                const res = await fetch('/v1/api/auth/me');
                if (!res.ok) return null;
                return res.json();
            } catch (error) {
                console.error('Ошибка получения данных пользователя:', error);
                return null;
            }
        }

        async function renderUser(user) {
            if (!user) {
                document.getElementById('userName').textContent = 'Ошибка загрузки';
                return;
            }

            document.getElementById('userName').textContent = user.username || 'Неизвестно';
            document.getElementById('userUsername').textContent = user.username || '-';
            document.getElementById('userEmail').textContent = user.email || '-';
            
            const roleText = getRoleText(user.role);
            const roleClass = getRoleClass(user.role);
            
            document.getElementById('userRole').innerHTML = `<span class="role-badge ${roleClass}">${roleText}</span>`;
            document.getElementById('userRoleBadge').innerHTML = `<span class="role-badge ${roleClass}">${roleText}</span>`;
        }

        function getRoleText(role) {
            const roleTexts = {
                'USER': 'Пользователь',
                'CUSTOMER': 'Клиент',
                'SELLER': 'Продавец',
                'ADMIN': 'Администратор'
            };
            return roleTexts[role] || 'Неизвестно';
        }

        function getRoleClass(role) {
            const roleClasses = {
                'USER': 'role-user',
                'CUSTOMER': 'role-customer',
                'SELLER': 'role-seller',
                'ADMIN': 'role-admin'
            };
            return roleClasses[role] || 'role-user';
        }

        async function loadOrders() {
            try {
                const res = await fetch('/v1/api/me/orders');
                if (!res.ok) {
                    showEmptyOrders();
                    return;
                }
                
                const orders = await res.json();
                renderOrders(orders);
            } catch (error) {
                console.error('Ошибка загрузки заказов:', error);
                showEmptyOrders();
            }
        }

        function renderOrders(orders) {
            const ordersContainer = document.getElementById('ordersList');
            const emptyOrders = document.getElementById('emptyOrders');
            
            if (!orders || orders.length === 0) {
                showEmptyOrders();
                return;
            }

            emptyOrders.classList.add('d-none');
            ordersContainer.innerHTML = '';

            orders.forEach(order => {
                const orderElement = document.createElement('div');
                orderElement.className = 'order-item';
                
                const orderDate = order.createdAt ? new Date(order.createdAt).toLocaleDateString('ru-RU') : 'Неизвестно';
                const statusClass = getStatusClass(order.status);
                const statusText = getStatusText(order.status);
                
                orderElement.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <div class="order-id">Заказ #${order.id}</div>
                            <div class="order-date">${orderDate}</div>
                        </div>
                        <div class="col-md-4">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="order-amount">${order.totalAmount || 0} ₽</div>
                        </div>
                    </div>
                `;
                ordersContainer.appendChild(orderElement);
            });
        }

        function showEmptyOrders() {
            document.getElementById('ordersList').innerHTML = '';
            document.getElementById('emptyOrders').classList.remove('d-none');
        }

        function getStatusText(status) {
            const statusTexts = {
                'CREATED': 'Создан',
                'PAID': 'Оплачен',
                'SHIPPED': 'Отправлен',
                'COMPLETED': 'Завершен',
                'CANCELLED': 'Отменен'
            };
            return statusTexts[status] || 'Неизвестно';
        }

        function getStatusClass(status) {
            const statusClasses = {
                'CREATED': 'status-created',
                'PAID': 'status-paid',
                'SHIPPED': 'status-shipped',
                'COMPLETED': 'status-completed',
                'CANCELLED': 'status-cancelled'
            };
            return statusClasses[status] || 'status-created';
        }

        function viewOrderDetails(orderId) {
            alert(`Детали заказа #${orderId} будут доступны в следующей версии`);
        }

        async function loadAddresses() {
            try {
                const res = await fetch('/v1/api/me/addresses');
                if (!res.ok) {
                    showEmptyAddresses();
                    return;
                }
                const addresses = await res.json();
                renderAddresses(addresses);
            } catch (e) {
                console.error('Ошибка загрузки адресов:', e);
                showEmptyAddresses();
            }
        }

        function renderAddresses(addresses) {
            const list = document.getElementById('addressesList');
            const empty = document.getElementById('emptyAddresses');
            if (!addresses || addresses.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('d-none');
                return;
            }
            empty.classList.add('d-none');
            list.innerHTML = '';
            addresses.forEach(a => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.innerHTML = `<span>${a.street}, ${a.city}, ${a.postalCode}, ${a.country}</span>`;
                list.appendChild(item);
            });
        }

        function showEmptyAddresses() {
            document.getElementById('addressesList').innerHTML = '';
            document.getElementById('emptyAddresses').classList.remove('d-none');
        }

        async function attachAddressForm() {
            const form = document.getElementById('addressForm');
            if (!form) return;
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const payload = {
                    street: document.getElementById('addrStreet').value.trim(),
                    city: document.getElementById('addrCity').value.trim(),
                    country: document.getElementById('addrCountry').value.trim(),
                    postalCode: document.getElementById('addrPostal').value.trim()
                };
                if (!payload.street || !payload.city || !payload.country || !payload.postalCode) return;
                try {
                    const res = await fetch('/v1/api/me/addresses', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (res.ok) {
                        form.reset();
                        await loadAddresses();
                    }
                } catch (e2) {
                    console.error('Ошибка сохранения адреса:', e2);
                }
            }, { once: true });
        }
    </script>
</body>
</html>