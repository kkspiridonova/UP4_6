<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Каталог</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: #f6f7fb; }
        .navbar-blur { backdrop-filter: saturate(180%) blur(10px); background: linear-gradient(90deg,#fff 0,#f9fbff 100%); border-bottom: 1px solid #eef2f7; }
        .brand-title { font-weight: 700; letter-spacing: .3px; }
        .toolbar .btn { border-radius: 10px; font-weight: 500; }
        .filters-card { border: none; border-radius: 14px; box-shadow: 0 6px 18px rgba(16,24,40,.06); }
        .product-card { height: 100%; border: none; border-radius: 16px; overflow: hidden; box-shadow: 0 8px 24px rgba(16,24,40,.08); transition: transform .15s ease, box-shadow .15s ease; }
        .product-card:hover { transform: translateY(-3px); box-shadow: 0 14px 30px rgba(16,24,40,.12); }
        .price-tag { background: #0d6efd10; color:#0d6efd; border: 1px solid #0d6efd20; padding: 6px 10px; border-radius: 999px; font-weight: 600; }
        .card-title { font-weight: 700; font-size: 1.05rem; }
        .muted { color:#6b7280; }
        .add-btn { border-radius: 10px; }
        .admin-links .btn { border-radius: 10px; }
        .nav-tabs { border: none; }
        .nav-tabs .nav-link { border: none; border-radius: 10px 10px 0 0; color: #6b7280; font-weight: 500; padding: 12px 20px; margin-right: 4px; }
        .nav-tabs .nav-link:hover { border: none; background: #f8fafc; color: #374151; }
        .nav-tabs .nav-link.active { background: #0d6efd; color: white; border: none; }
        .tab-content { background: white; border-radius: 0 16px 16px 16px; box-shadow: 0 8px 24px rgba(16,24,40,.08); padding: 30px; }
        .admin-tabs { margin-bottom: 20px; }
        .btn-action { border-radius: 8px; padding: 6px 12px; font-size: 0.875rem; font-weight: 500; }
        .btn-edit { background: #0d6efd10; color: #0d6efd; border: 1px solid #0d6efd20; }
        .btn-edit:hover { background: #0d6efd; color: white; }
        .btn-delete { background: #dc354510; color: #dc3545; border: 1px solid #dc354520; }
        .btn-delete:hover { background: #dc3545; color: white; }
        .btn-add { background: linear-gradient(135deg, #28a745, #20c997); border: none; color: white; font-weight: 600; }
        .btn-add:hover { background: linear-gradient(135deg, #20c997, #17a2b8); color: white; }
        .empty-state { text-align: center; padding: 60px 20px; color: #6b7280; }
        .empty-state i { font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; }
        .form-control:focus, .form-select:focus { border-color: #0d6efd; box-shadow: 0 0 0 3px rgba(13,110,253,.1); }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light navbar-blur sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand brand-title" href="/catalog">
                <i class="fas fa-shopping-bag me-2"></i>Cosmetic Store
            </a>
            <div class="toolbar d-flex align-items-center gap-2">
                <nav id="adminTopNav" class="d-none d-md-flex align-items-center gap-1 me-2"></nav>
                <a href="#" id="cartLink" class="btn btn-outline-primary">
                    <i class="fas fa-shopping-cart me-1"></i>Корзина
                </a>
                <a href="/profile" class="btn btn-outline-secondary">
                    <i class="fas fa-user me-1"></i>Профиль
                </a>
                <a href="/logout" class="btn btn-outline-danger">
                    <i class="fas fa-sign-out-alt me-1"></i>Выйти
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4 fw-bold text-dark">
                    <i class="fas fa-shopping-bag me-2 text-primary"></i>Каталог товаров
                </h2>

                <div class="card filters-card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Категория</label>
                                <select id="filterCategory" class="form-select">
                                    <option value="">Все категории</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Поиск по названию</label>
                                <input id="searchName" class="form-control" placeholder="Введите название товара...">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Сортировка</label>
                                <select id="sortBy" class="form-select">
                                    <option value="name_asc">Название (А→Я)</option>
                                    <option value="name_desc">Название (Я→А)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="userContent">
                    <div class="row g-3" id="products"></div>
                    <nav class="mt-4">
                        <ul class="pagination justify-content-center" id="pager">
                            <li class="page-item"><button class="page-link" id="prevPage">Назад</button></li>
                            <li class="page-item disabled"><span class="page-link" id="pageInfo">1 / 1</span></li>
                            <li class="page-item"><button class="page-link" id="nextPage">Вперёд</button></li>
                        </ul>
                    </nav>
                </div>

                <div id="adminContent" class="d-none">
                    <div class="card" style="border: none; border-radius: 16px; box-shadow: 0 8px 24px rgba(16,24,40,.08);">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="fw-bold mb-0">Управление товарами</h5>
                                <button class="btn btn-add" onclick="window.location.href='/product-edit'">
                                    <i class="fas fa-plus me-1"></i>Добавить товар
                                </button>
                            </div>
                            <div class="row g-3" id="adminProducts"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 0;
        let totalPages = 1;
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            currentUser = await getMe();
            await loadCategories();
            
            if (currentUser && (currentUser.role === 'SELLER' || currentUser.role === 'ADMIN')) {
                buildAdminTopNav(currentUser.role);
                showAdminContent();
            } else {
                showUserContent();
            }

            document.getElementById('filterCategory').addEventListener('change', () => loadProducts());
            document.getElementById('searchName').addEventListener('input', debounce(() => loadProducts(), 300));
            document.getElementById('sortBy').addEventListener('change', () => loadProducts());
            document.getElementById('prevPage').addEventListener('click', () => loadProducts(currentPage - 1));
            document.getElementById('nextPage').addEventListener('click', () => loadProducts(currentPage + 1));
        });

        function showAdminContent() {
            document.getElementById('userContent').classList.add('d-none');
            document.getElementById('adminContent').classList.remove('d-none');
            document.getElementById('cartLink').style.display = 'none';
            loadAdminData();
        }

        function showUserContent() {
            document.getElementById('userContent').classList.remove('d-none');
            document.getElementById('adminContent').classList.add('d-none');
            document.getElementById('cartLink').href = '/cart-page';
            loadProducts();
        }

        async function loadAdminData() {
            await loadAdminProducts();
        }

        async function loadProducts(pageIndex = currentPage) {
            const q = (document.getElementById('searchName')?.value || '').trim().toLowerCase();
            const catId = Number(document.getElementById('filterCategory')?.value || '0') || null;
            const sort = document.getElementById('sortBy')?.value || 'name_asc';
            
            const res = await fetch(`/v1/api/catalog/products?page=${pageIndex}&size=10`);
            if (!res.ok) return;
            
            const pg = await res.json();
            currentPage = pg.number || 0;
            totalPages = pg.totalPages || 1;
            
            document.getElementById('pageInfo').textContent = `${currentPage + 1} / ${Math.max(totalPages,1)}`;
            document.getElementById('prevPage').disabled = currentPage <= 0;
            document.getElementById('nextPage').disabled = currentPage >= totalPages - 1;

            let products = pg.content || [];
            if (catId) products = products.filter(p => p.category?.id === catId);
            if (q) products = products.filter(p => (p.name || '').toLowerCase().includes(q));
            if (sort === 'name_asc') products.sort((a,b) => (a.name||'').localeCompare(b.name||''));
            if (sort === 'name_desc') products.sort((a,b) => (b.name||'').localeCompare(a.name||''));

            renderProducts(products, 'products', false);
        }

        async function loadAdminProducts() {
            try {
                const res = await fetch('/v1/api/admin/catalog/products');
                if (!res.ok) return;
                const products = await res.json();
                renderProducts(products, 'adminProducts', true);
            } catch (error) {
                console.error('Ошибка загрузки товаров:', error);
            }
        }


        function renderProducts(products, containerId, isAdmin) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (products.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="fas fa-box"></i>
                            <h5>Товары не найдены</h5>
                            <p>Попробуйте изменить параметры поиска</p>
                        </div>
                    </div>
                `;
                return;
            }

            products.forEach(product => {
                const col = document.createElement('div');
                col.className = 'col-12 col-sm-6 col-md-4 col-lg-3';
                
                const actions = isAdmin ? `
                    <div class="d-flex gap-1 mt-2">
                        <button class="btn btn-action btn-edit" onclick="window.location.href='/product-edit/${product.id}'" title="Редактировать">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-action btn-delete" onclick="deleteProduct(${product.id})" title="Удалить">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                ` : `
                    <button class="btn btn-primary add-btn w-100 mt-2" onclick="addToCart(${product.id})">
                        <i class="fas fa-cart-plus me-1"></i>В корзину
                    </button>
                `;

                col.innerHTML = `
                    <div class="card product-card">
                        <div class="card-body">
                            <h6 class="card-title">${product.name}</h6>
                            <p class="card-text muted small">${product.description || 'Описание отсутствует'}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="price-tag">${product.price} ₽</span>
                                <small class="muted">Остаток: ${product.stock || 0}</small>
                            </div>
                            ${actions}
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }


        async function loadCategories() {
            try {
                const res = await fetch('/v1/api/catalog/categories');
                if (!res.ok) return;
                const categories = await res.json();
                const select = document.getElementById('filterCategory');
                select.innerHTML = '<option value="">Все категории</option>';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Ошибка загрузки категорий:', error);
            }
        }

        async function addToCart(productId) {
            try {
                const response = await fetch('/v1/api/cart/items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId, quantity: 1 })
                });
                if (response.ok) {
                    alert('Товар добавлен в корзину!');
                } else {
                    alert('Ошибка добавления в корзину');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка добавления в корзину');
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('Вы уверены, что хотите удалить этот товар?')) return;
            
            try {
                const response = await fetch(`/v1/api/admin/catalog/products/${productId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    loadAdminProducts();
                } else {
                    alert('Ошибка удаления товара');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка удаления товара');
            }
        }

        async function getMe() {
            try {
                const res = await fetch('/v1/api/auth/me');
                if (!res.ok) return null;
                return res.json();
            } catch (error) {
                console.error('Ошибка получения данных пользователя:', error);
                return null;
            }
        }

        function buildAdminTopNav(role) {
            const nav = document.getElementById('adminTopNav');
            if (!nav) return;
            const links = [];
            if (role === 'ADMIN') {
                links.push({ href: '/admin/brands', label: 'Бренды', icon: 'fa-tags' });
                links.push({ href: '/admin/categories', label: 'Категории', icon: 'fa-layer-group' });
                links.push({ href: '/admin/orders', label: 'Заказы', icon: 'fa-shopping-bag' });
                links.push({ href: '/admin/addresses', label: 'Адреса', icon: 'fa-map-marker-alt' });
                links.push({ href: '/admin/users', label: 'Пользователи', icon: 'fa-users' });
            }
            nav.innerHTML = '';
            links.forEach(l => {
                const a = document.createElement('a');
                a.href = l.href;
                a.className = 'btn btn-outline-secondary';
                a.innerHTML = `<i class="fas ${l.icon} me-1"></i>${l.label}`;
                nav.appendChild(a);
            });
            nav.classList.remove('d-none');
        }

        function debounce(fn, wait) {
            let t;
            return (...a) => {
                clearTimeout(t);
                t = setTimeout(() => fn(...a), wait);
            };
        }
    </script>
</body>
</html>